<?php
$basePath = dirname(__DIR__);
$config = require $basePath . '/config.php';
$rawPath = $basePath . '/raw/geocoding';
$fc = [
    'type' => 'FeatureCollection',
    'features' => [],
];

$missing = [
    '南投縣南投市袓祠路242巷38號' => [],
    '南投縣集集鎮育才街147號' => [],
    '嘉義市嘉義市過溪91號' => [],
    '嘉義市嘉義市北社尾674之5號' => [],
    '嘉義市嘉義市啟明路3號、垂楊路2之1號' => [],
    '嘉義縣竹崎鄉埤堂23巷82號' => [],
    '嘉義縣阿里山鄉78號' => [],
    '嘉義縣阿里山鄉96號' => [],
    '嘉義縣中埔鄉13-1號' => [],
    '嘉義縣水上鄉2-1號' => [],
    '嘉義縣水上鄉111號' => [],
    '嘉義縣水上鄉153-1號' => [],
    '嘉義縣太保市86之3號' => [],
    '嘉義縣朴子市34號之3' => [],
    '嘉義縣朴子市345號' => [],
    '嘉義縣六腳鄉122號' => [],
    '嘉義縣新港鄉123號' => [],
    '嘉義縣新港鄉75之4號' => [],
    '嘉義縣新港鄉635~642號' => [],
    '嘉義縣民雄鄉86之15號' => [],
    '嘉義縣溪口鄉107號' => [],
    '嘉義縣義竹鄉423-2號' => [],
    '宜蘭縣大同鄉梵梵巷100號' => [],
    '屏東縣屏東市建豊路84巷8號' => [],
    '屏東縣三地門鄉2號' => [],
    '屏東縣三地門鄉4號' => [],
    '屏東縣三地門鄉18號' => [],
    '屏東縣瑪家鄉27號' => [],
    '屏東縣瑪家鄉風景路1-18號1樓' => [],
    '屏東縣泰武鄉1號' => [],
    '屏東縣泰武鄉10號' => [],
    '屏東縣來義鄉新樂路1號' => [],
    '屏東縣來義鄉165號' => [],
    '屏東縣來義鄉51號' => [],
    '屏東縣林邊鄉農榮路5巷47號' => [],
    '屏東縣新園鄉鹽洲路379號' => [],
    '屏東縣枋山鄉光復路24號' => [],
    '屏東縣春日鄉65號' => [],
    '屏東縣獅子鄉1號' => [],
    '屏東縣牡丹鄉93號' => [],
    '彰化縣彰化市南平街121.123.125.127號' => [],
    '彰化縣秀水鄉通鹿巷188弄76號' => [],
    '彰化縣員林市山腳路4段212號' => [],
    '新北市瑞芳區四腳亭埔路23號' => [],
    '新北市雙溪區政光路3號' => [],
    '新北市坪林區坪林街114號' => [],
    '新北市中和區中和市復興路280巷46弄3、4、5號' => [],
    '新北市中和區中和市安平路68號1樓及夾層' => [],
    '新北市土城區永和路23號1樓,2樓' => [],
    '新北市三峽區建安路67號' => [],
    '新北市三峽區白雞路40號' => [],
    '新北市三峽區69號' => [],
    '新北市三峽區39號' => [],
    '新北市樹林區啟智街106號1-2樓' => [],
    '新北市三重區三民路175巷25號1-2樓、27號1-3樓、重陽路2段52巷83弄4號1樓、6號1-3樓' => [],
    '新北市新莊區新莊市昌平街71巷20號1樓、22號1樓' => [],
    '新北市林口區10之1號' => [],
    '新北市林口區文化1路1段120號（1層）、2、3樓' => [],
    '新北市蘆洲區中華路85號1~2樓、83號2樓' => [],
    '新北市三芝區5號' => [],
    '新北市萬里區加投路14號' => [],
    '新北市萬里區港東路167號' => [],
    '新北市萬里區大坪路1號' => [],
    '新北市汐止區汐止市莊敬街130號2樓' => [],
    '新北市汐止區汐止市民族三街1號1樓' => [],
    '新竹市新竹市科學工業區力行路25號3樓' => [],
    '新竹市新竹市科學園區研新三路一號' => [],
    '新竹市新竹市科學園區園區二路9號1樓' => [],
    '新竹市新竹市光明新村186號' => [],
    '新竹縣竹北市東海2街100號' => [],
    '新竹縣竹北市光明3路184號' => [],
    '新竹縣湖口鄉138巷4之8號' => [],
    '新竹縣新豐鄉466號' => [],
    '新竹縣新豐鄉37號' => [],
    '新竹縣新豐鄉108號' => [],
    '新竹縣新豐鄉明德巷13號' => [],
    '新竹縣新豐鄉63號' => [],
    '新竹縣關西鎮25號' => [],
    '新竹縣關西鎮107號' => [],
    '新竹縣五峰鄉243號' => [],
    '新竹縣五峰鄉123號' => [],
    '新竹縣五峰鄉174號' => [],
    '新竹縣五峰鄉94-1號' => [],
    '新竹縣五峰鄉379號' => [],
    '新竹縣橫山鄉110號' => [],
    '新竹縣橫山鄉101號' => [],
    '新竹縣尖石鄉19號' => [],
    '新竹縣尖石鄉5號' => [],
    '新竹縣尖石鄉10號' => [],
    '新竹縣尖石鄉25號' => [],
    '新竹縣尖石鄉49號' => [],
    '新竹縣尖石鄉116號' => [],
    '新竹縣尖石鄉59號' => [],
    '新竹縣尖石鄉17號' => [],
    '新竹縣尖石鄉34號' => [],
    '桃園市中壢區山東1路39號' => [],
    '桃園市中壢區內定20街205巷2號' => [],
    '桃園市楊梅區60之1號' => [],
    '桃園市觀音區5號' => [],
    '桃園市桃園區同德11街48號' => [],
    '桃園市桃園區廈門街68號' => [],
    '桃園市桃園區正光街71巷10-1號' => [],
    '桃園市桃園區正光街122號1樓' => [],
    '桃園市桃園區國強12街45號' => [],
    '桃園市龜山區光峰路277號' => [],
    '桃園市龜山區光峰路1號' => [],
    '桃園市八德區高城8街19巷10弄1號1-3樓' => [],
    '桃園市大溪區240號1-2樓' => [],
    '桃園市大溪區僑愛新村僑愛巷58號1樓' => [],
    '桃園市復興區75號' => [],
    '桃園市復興區28號' => [],
    '桃園市復興區16號' => [],
    '桃園市復興區11號' => [],
    '桃園市復興區57號' => [],
    '桃園市復興區12號' => [],
    '桃園市復興區2號1-2樓' => [],
    '桃園市復興區14號' => [],
    '桃園市大園區82-4號' => [],
    '桃園市大園區17號' => [],
    '桃園市大園區41號' => [],
    '澎湖縣馬公市104-14號' => [],
    '澎湖縣馬公市86-10號' => [],
    '澎湖縣馬公市19號' => [],
    '澎湖縣馬公市32-20號' => [],
    '澎湖縣西嶼鄉104號' => [],
    '澎湖縣西嶼鄉4之28號' => [],
    '澎湖縣西嶼鄉15之9號' => [],
    '澎湖縣望安鄉12-8號' => [],
    '澎湖縣望安鄉46號' => [],
    '澎湖縣望安鄉2號' => [],
    '澎湖縣七美鄉1號' => [],
    '澎湖縣白沙鄉8號' => [],
    '澎湖縣白沙鄉370號' => [],
    '澎湖縣白沙鄉小赤崁村51-7號' => [],
    '澎湖縣白沙鄉2之5號' => [],
    '澎湖縣白沙鄉57號' => [],
    '澎湖縣湖西鄉15號' => [],
    '澎湖縣湖西鄉75號' => [],
    '澎湖縣湖西鄉180號' => [],
    '澎湖縣湖西鄉151號' => [],
    '臺中市北屯區軍福7路37號' => [],
    '臺中市太平區大源19街28-6號1.2樓' => [],
    '臺中市豐原區褔德路2之1號2樓' => [],
    '臺中市潭子區勝利12街43號1樓及勝利12街51巷1號1~3樓' => [],
    '臺中市潭子區勝利5街41號' => [],
    '臺中市沙鹿區北勢2街12-1號1~3樓' => [],
    '臺中市大安區東西4路252號' => [],
    '臺中市大安區褔安路38號' => [],
    '臺北市中正區汀洲路三段4號' => [],
    '臺北市大同區大同區哈密街59巷83號1-2樓' => [],
    '臺北市中山區樂群2路266巷99號' => [],
    '臺北市大安區羅斯褔路四段21號' => [],
    '臺北市信義區褔德街253號' => [],
    '臺北市文山區政大1街19號1樓至4樓' => [],
    '臺南市東區崇德廿二街65號' => [],
    '臺南市北區海安路三段833、835、837、839號' => [],
    '臺南市安南區長河路二段74號' => [],
    '臺南市永康區鹽行路2號' => [],
    '臺南市永康區鹽洲一街27號' => [],
    '臺南市新化區54號' => [],
    '臺南市左鎮區7號' => [],
    '臺南市左鎮區61之1號' => [],
    '臺南市玉井區115號' => [],
    '臺南市玉井區3-3號' => [],
    '臺南市南化區17號' => [],
    '臺南市南化區110之27號' => [],
    '臺南市南化區96號' => [],
    '臺南市南化區48之1號' => [],
    '臺南市南化區117號' => [],
    '臺南市仁德區108號' => [],
    '臺南市仁德區28-8號' => [],
    '臺南市官田區11號' => [],
    '臺南市官田區77-1號' => [],
    '臺南市官田區56-39號' => [],
    '臺南市麻豆區86號' => [],
    '臺南市麻豆區231號' => [],
    '臺南市麻豆區9號' => [],
    '臺南市麻豆區113號' => [],
    '臺南市麻豆區140-38號' => [],
    '臺南市佳里區214號' => [],
    '臺南市佳里區40號' => [],
    '臺南市佳里區136號' => [],
    '臺南市佳里區5之1號' => [],
    '臺南市佳里區121-2號' => [],
    '臺南市佳里區76-2號' => [],
    '臺南市西港區11號' => [],
    '臺南市西港區3號' => [],
    '臺南市七股區130號' => [],
    '臺南市七股區100號' => [],
    '臺南市七股區272號' => [],
    '臺南市將軍區176號' => [],
    '臺南市將軍區4號' => [],
    '臺南市將軍區6號' => [],
    '臺南市北門區35-2號' => [],
    '臺南市北門區791號' => [],
    '臺南市北門區118-1號' => [],
    '臺南市新營區316號' => [],
    '臺南市新營區71-1號' => [],
    '臺南市新營區1號' => [],
    '臺南市新營區52號' => [],
    '臺南市後壁區195號' => [],
    '臺南市後壁區5號' => [],
    '臺南市後壁區81號' => [],
    '臺南市後壁區210-2號' => [],
    '臺南市後壁區282號' => [],
    '臺南市後壁區173-15號' => [],
    '臺南市後壁區89-5號' => [],
    '臺南市白河區85號' => [],
    '臺南市白河區83-1號' => [],
    '臺南市白河區3號' => [],
    '臺南市白河區1號' => [],
    '臺南市白河區113號' => [],
    '臺南市白河區22號' => [],
    '臺南市東山區8號' => [],
    '臺南市東山區15號' => [],
    '臺南市東山區16號' => [],
    '臺南市下營區270號' => [],
    '臺南市柳營區61號' => [],
    '臺南市柳營區4-1號' => [],
    '臺南市柳營區132-12號' => [],
    '臺南市鹽水區10-3號' => [],
    '臺南市鹽水區117號' => [],
    '臺南市鹽水區31號' => [],
    '臺南市鹽水區202號' => [],
    '臺南市善化區280號' => [],
    '臺南市善化區300號' => [],
    '臺南市善化區245號' => [],
    '臺南市善化區200-1號' => [],
    '臺南市大內區63號' => [],
    '臺南市大內區154號' => [],
    '臺南市山上區42號' => [],
    '臺南市新市區39號' => [],
    '臺南市新市區537-13號' => [],
    '臺南市安定區62號' => [],
    '臺南市安定區1號' => [],
    '臺南市安定區30號' => [],
    '臺南市安定區17-3號' => [],
    '臺南市安定區224-2號' => [],
    '臺南市安定區332-4號' => [],
    '臺南市安定區15-12號' => [],
    '臺南市安定區46-2號' => [],
    '臺東縣綠島鄉3號' => [],
    '臺東縣綠島鄉98號' => [],
    '臺東縣蘭嶼鄉1號' => [],
    '臺東縣蘭嶼鄉17號' => [],
    '臺東縣延平鄉14號' => [],
    '臺東縣延平鄉16號' => [],
    '臺東縣卑南鄉6號' => [],
    '臺東縣卑南鄉666號' => [],
    '臺東縣卑南鄉474巷2號' => [],
    '臺東縣關山鎮中興路93號' => [],
    '臺東縣海端鄉12號' => [],
    '臺東縣海端鄉文化路1號' => [],
    '臺東縣海端鄉5號' => [],
    '臺東縣池上鄉5-2號' => [],
    '臺東縣池上鄉36號' => [],
    '臺東縣池上鄉87號' => [],
    '臺東縣東河鄉431號' => [],
    '臺東縣東河鄉297號' => [],
    '臺東縣東河鄉35號' => [],
    '臺東縣東河鄉155號' => [],
    '臺東縣長濱鄉41號' => [],
    '臺東縣長濱鄉7號' => [],
    '臺東縣長濱鄉11號' => [],
    '臺東縣長濱鄉14號' => [],
    '臺東縣長濱鄉16號' => [],
    '臺東縣太麻里鄉28號' => [],
    '臺東縣太麻里鄉90號' => [],
    '臺東縣金峰鄉1號' => [],
    '臺東縣金峰鄉68號' => [],
    '臺東縣金峰鄉155號' => [],
    '臺東縣大武鄉12號' => [],
    '臺東縣達仁鄉113號' => [],
    '臺東縣達仁鄉10號' => [],
    '臺東縣達仁鄉106號' => [],
    '花蓮縣花蓮市忠義1街28號' => [],
    '花蓮縣花蓮市民權7街12號' => [],
    '花蓮縣花蓮市民權8街5號' => [],
    '花蓮縣花蓮市國富20街6號' => [],
    '花蓮縣秀林鄉69號' => [],
    '花蓮縣秀林鄉111號' => [],
    '花蓮縣秀林鄉秀林路76號' => [],
    '花蓮縣秀林鄉112號' => [],
    '花蓮縣秀林鄉72號' => [],
    '花蓮縣秀林鄉127號' => [],
    '花蓮縣秀林鄉133號' => [],
    '花蓮縣秀林鄉和平路101號' => [],
    '花蓮縣吉安鄉永興6街83號' => [],
    '花蓮縣吉安鄉南埔13街162巷2號' => [],
    '花蓮縣壽豐鄉水璉2街20號' => [],
    '花蓮縣豐濱鄉150號' => [],
    '花蓮縣瑞穗鄉47號' => [],
    '花蓮縣瑞穗鄉中山2段389號' => [],
    '花蓮縣萬榮鄉明村35號' => [],
    '花蓮縣萬榮鄉114號' => [],
    '花蓮縣萬榮鄉4號' => [],
    '花蓮縣玉里鎮212號' => [],
    '花蓮縣玉里鎮163號' => [],
    '花蓮縣玉里鎮118號' => [],
    '花蓮縣玉里鎮225號' => [],
    '花蓮縣玉里鎮城西1街29號' => [],
    '花蓮縣卓溪鄉90號' => [],
    '花蓮縣卓溪鄉2號' => [],
    '花蓮縣卓溪鄉79-1號' => [],
    '花蓮縣富里鄉16號' => [],
    '花蓮縣富里鄉永豐路84號' => [],
    '苗栗縣後龍鎮158號' => [],
    '苗栗縣後龍鎮9-28號' => [],
    '苗栗縣通霄鎮30-1號' => [],
    '苗栗縣通霄鎮117號' => [],
    '苗栗縣苑裡鎮南苑三巷14、15號' => [],
    '苗栗縣苑裡鎮111號' => [],
    '苗栗縣造橋鄉54號' => [],
    '苗栗縣公館鄉260號' => [],
    '苗栗縣大湖鄉25號' => [],
    '苗栗縣銅鑼鄉91-1號' => [],
    '苗栗縣銅鑼鄉12-1號' => [],
    '苗栗縣銅鑼鄉150號' => [],
    '連江縣南竿鄉13號' => [],
    '連江縣北竿鄉56號' => [],
    '連江縣莒光鄉4號' => [],
    '連江縣莒光鄉19號' => [],
    '連江縣東引鄉94號' => [],
    '金門縣金湖鎮9之1號' => [],
    '雲林縣斗南鎮文安路1之2號' => [],
    '雲林縣大埤鄉仁和路4-1號' => [],
    '雲林縣虎尾鎮39-2號' => [],
    '雲林縣虎尾鎮39-1號' => [],
    '雲林縣虎尾鎮39號' => [],
    '雲林縣虎尾鎮大屯路368號' => [],
    '雲林縣褒忠鄉96號' => [],
    '雲林縣臺西鄉12號' => [],
    '雲林縣麥寮鄉忠和路8號' => [],
    '雲林縣麥寮鄉227號' => [],
    '雲林縣林內鄉瑞農路56之1號' => [],
    '雲林縣林內鄉重興路124-5號' => [],
    '雲林縣古坑鄉41號' => [],
    '雲林縣古坑鄉棋山路49號' => [],
    '雲林縣西螺鎮44號' => [],
    '雲林縣北港鎮76號' => [],
    '雲林縣北港鎮20號' => [],
    '雲林縣北港鎮劉厝路20之6號' => [],
    '雲林縣元長鄉北水路8號' => [],
    '高雄市前鎮區翠享北路281號' => [],
    '高雄市三民區大褔街168號' => [],
    '高雄市楠梓區大學26街1150號' => [],
    '高雄市小港區民益路110、112、114、116號' => [],
    '高雄市阿蓮區272號' => [],
    '高雄市鳥松區本館路3-13號' => [],
    '高雄市鳥松區本館路287號1樓' => [],
    '高雄市鳥松區本館路92之2號1至2樓、92之3號1至3樓' => [],
    '高雄市美濃區吉頂路19號' => [],
    '高雄市內門區內埔路24號' => [],
    '高雄市內門區萊坑路8號' => [],
    '高雄市桃源區180-10號' => [],
];
foreach(glob($basePath . '/data/*.csv') AS $csvFile) {
    $fh = fopen($csvFile, 'r');
    $head = fgetcsv($fh, 2048);
    while($line = fgetcsv($fh, 2048)) {
        $data = array_combine($head, $line);
        $fullAddress = $data['city'] . $data['town'] . substr($data['address'], strpos($data['address'], ']') + 1);
        $cityPath = $rawPath . '/' . $data['city'];
        if(!file_exists($cityPath)) {
            mkdir($cityPath, 0777, true);
        }
        $rawFile = $cityPath . '/' . $fullAddress . '.json';
        if(!file_exists($rawFile)) {
            $apiUrl = $config['tgos']['url'] . '?' . http_build_query([
                'oAPPId' => $config['tgos']['APPID'], //應用程式識別碼(APPId)
                'oAPIKey' => $config['tgos']['APIKey'], // 應用程式介接驗證碼(APIKey)
                'oAddress' => $fullAddress, //所要查詢的門牌位置
                'oSRS' => 'EPSG:4326', //回傳的坐標系統
                'oFuzzyType' => '2', //模糊比對的代碼
                'oResultDataType' => 'JSON', //回傳的資料格式
                'oFuzzyBuffer' => '0', //模糊比對回傳門牌號的許可誤差範圍
                'oIsOnlyFullMatch' => 'false', //是否只進行完全比對
                'oIsLockCounty' => 'true', //是否鎖定縣市
                'oIsLockTown' => 'false', //是否鎖定鄉鎮市區
                'oIsLockVillage' => 'false', //是否鎖定村里
                'oIsLockRoadSection' => 'false', //是否鎖定路段
                'oIsLockLane' => 'false', //是否鎖定巷
                'oIsLockAlley' => 'false', //是否鎖定弄
                'oIsLockArea' => 'false', //是否鎖定地區
                'oIsSameNumber_SubNumber' => 'true', //號之、之號是否視為相同
                'oCanIgnoreVillage' => 'true', //找不時是否可忽略村里
                'oCanIgnoreNeighborhood' => 'true', //找不時是否可忽略鄰
                'oReturnMaxCount' => '0', //如為多筆時，限制回傳最大筆數
            ]);
            $content = file_get_contents($apiUrl);
            $pos = strpos($content, '{');
            $posEnd = strrpos($content, '}') + 1;
            file_put_contents($rawFile, substr($content, $pos, $posEnd - $pos));
        }
        $json = json_decode(file_get_contents($rawFile), true);
        if(!empty($json['AddressList'][0]['X'])) {
            $fc['features'][] = [
                'type' => 'Feature',
                'properties' => $data,
                'geometry' => [
                    'type' => 'Point',
                    'coordinates' => [
                        $json['AddressList'][0]['X'],
                        $json['AddressList'][0]['Y']
                    ],
                ],
            ];
        }
    }
}
file_put_contents($basePath . '/preschools.json', json_encode($fc, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));